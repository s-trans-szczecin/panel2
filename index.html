<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS | Panel Admina</title>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin:0;
  font-family:Arial;
  background:#0b0f1a;
  color:white;
}

/* === SPLASH === */
#splash {
  height:100vh;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:48px;
  letter-spacing:5px;
  background:linear-gradient(135deg,#0ff,#003);
  animation:pulse 2s infinite;
}
@keyframes pulse {
  0%{opacity:.4}
  50%{opacity:1}
  100%{opacity:.4}
}

/* === WELCOME === */
#welcome {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 9999;
}

.metropolis-bg {
  position: absolute;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #001f3f, #000);
  opacity: 0.8;
}

.logo-container {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  perspective: 1000px;
  cursor: pointer;
}

.logo-text {
  font-size: 5rem;
  font-weight: 900;
  letter-spacing: 10px;
  color: rgba(0, 242, 255, 0.25);
  text-shadow: 0 0 10px #00f2ff, 0 0 20px #39ff14;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(12px);
  padding: 20px 40px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  animation: rotateHolo 8s linear infinite;
}

@keyframes rotateHolo {
  from { transform: rotateY(0deg); }
  to { transform: rotateY(360deg); }
}

/* === LOGIN === */
#login {
  display:none;
  padding:40px;
  text-align:center;
}

/* === PANEL === */
#panel {
  display:none;
  height:100vh;
}

#orders {
  width:40%;
  padding:10px;
  background: rgba(255,255,255,0.03);
  backdrop-filter: blur(10px);
}

#map {
  width:60%;
}

/* === TABELA === */
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}

th {
  background:linear-gradient(135deg,#00f2ff,#003);
  color:black;
  padding:10px;
  font-size:12px;
}

td {
  padding:10px;
}

tr:nth-child(even) {
  background:rgba(255,255,255,0.03);
}

tr:hover {
  background:rgba(0,242,255,0.15);
}

.status {
  background:rgba(0,242,255,0.2);
  border-radius:6px;
  padding:4px 8px;
  font-weight:bold;
}

/* === BUTTON === */
button {
  background:linear-gradient(135deg,#00f2ff,#003);
  border:none;
  padding:8px 12px;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
</style>

<script>
/* === FIREBASE === */
const firebaseConfig = {
  apiKey: "AIzaSyAqm4Z8xeZ1mYelt4giRQknCWG6RMzAs8c",
  authDomain: "fir-trans-projekt.firebaseapp.com",
  databaseURL: "https://fir-trans-projekt-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fir-trans-projekt",
  storageBucket: "fir-trans-projekt.firebasestorage.app",
  messagingSenderId: "285753383667",
  appId: "1:285753383667:web:95eaac335c2a1f1f3a3586"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let map;
let markers = {};

/* === START === */
window.onload = () => {
  document.getElementById("splash").style.display="flex";
  setTimeout(()=>{
    document.getElementById("splash").style.display="none";
  },2000);
};

/* === LOGO CLICK === */
document.addEventListener("DOMContentLoaded",()=>{
  document.querySelector(".logo-container").onclick = () => {
    const w = document.getElementById("welcome");
    w.style.transition="opacity .8s";
    w.style.opacity="0";
    setTimeout(()=>{
      w.style.display="none";
      document.getElementById("login").style.display="block";
    },800);
  };
});

/* === LOGIN === */
function login(){
  const email = emailInput.value;
  const pass = passwordInput.value;

  auth.signInWithEmailAndPassword(email,pass)
    .then(u=>{
      db.ref("users/"+u.user.uid).once("value").then(s=>{
        if(!s.exists() || s.val().role!=="admin"){
          alert("Brak roli ADMIN");
          auth.signOut();
          return;
        }
        document.getElementById("login").style.display="none";
        document.getElementById("panel").style.display="flex";
        initMap();
        loadOrders();
        loadDrivers();
      });
    })
    .catch(e=>loginError.innerText=e.message);
}

/* === MAPA === */
function initMap(){
  map=L.map('map').setView([53.4285,14.5528],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

/* === DRIVERS === */
function loadDrivers(){
  db.ref("drivers").on("value",snap=>{
    snap.forEach(d=>{
      const v=d.val();
      if(!v.lat||!v.lng)return;
      if(markers[d.key]) markers[d.key].setLatLng([v.lat,v.lng]);
      else markers[d.key]=L.marker([v.lat,v.lng]).addTo(map).bindPopup(v.name);
    });
  });
}

/* === ORDERS === */
function loadOrders(){
  ordersTable.innerHTML="<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th></tr>";
  db.ref("orders").on("value",snap=>{
    ordersTable.innerHTML="<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th></tr>";
    snap.forEach(o=>{
      const d=o.val();
      ordersTable.insertRow().innerHTML=`
        <td>${o.key}</td>
        <td>${d.title}</td>
        <td class="status">${d.status}</td>
        <td>${d.driverId||"-"}</td>`;
    });
  });
}

function newOrder(){
  const t=prompt("Tytuł zlecenia");
  if(t) db.ref("orders").push({title:t,status:"nowe",driverId:""});
}
</script>
</head>

<body>

<div id="splash">S-TRANS</div>

<div id="welcome">
  <div class="metropolis-bg"></div>
  <div class="logo-container">
    <div class="logo-text">S-TRANS</div>
  </div>
</div>

<div id="login">
  <h2>Logowanie admina</h2>
  <input id="emailInput" placeholder="email"><br><br>
  <input id="passwordInput" type="password" placeholder="hasło"><br><br>
  <button onclick="login()">Zaloguj</button>
  <p id="loginError" style="color:red"></p>
</div>

<div id="panel">
  <div id="orders">
    <h2>Zlecenia</h2>
    <button onclick="newOrder()">+ Nowe</button>
    <table id="ordersTable"></table>
  </div>
  <div id="map"></div>
</div>

</body>
</html>
