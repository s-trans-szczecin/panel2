<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS | Panel Admina</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { margin:0; font-family:Arial; background:#0b0f1a; color:#fff; }
h1 { text-align:center; padding:20px; letter-spacing:3px; }
#login, #panel { padding:20px; }
input, button { padding:10px; margin:5px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
td, th { border:1px solid #333; padding:6px; text-align:center; }
#map { height:400px; margin-top:20px; }
button { cursor:pointer; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Konfiguracja Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAjkKqpO-3_Ltp3Jofc4oDu81Y5pb2IsQk",
  authDomain: "fir-trans-10591.firebaseapp.com",
  databaseURL: "https://fir-trans-10591-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fir-trans-10591",
  storageBucket: "fir-trans-10591.appspot.com",
  messagingSenderId: "454345201943",
  appId: "1:454345201943:web:panel"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let map;
let driverMarkers = {};

// Logowanie admin
function login(){
  const email = document.getElementById("email").value;
  const pass = document.getElementById("pass").value;
  document.getElementById("loginError").innerText = "";

  auth.signInWithEmailAndPassword(email, pass)
    .then(res => {
      const uid = res.user.uid;
      db.ref("users/" + uid + "/role").once("value").then(snap => {
        if(snap.val() === "admin"){
          document.getElementById("login").style.display="none";
          document.getElementById("panel").style.display="block";
          loadOrders();
          initMap();
          startDriverUpdates();
        } else {
          alert("BRAK PRZYPISANEJ ROLI");
          auth.signOut();
        }
      });
    })
    .catch(err => { document.getElementById("loginError").innerText = err.message; });
}

// Tabela zleceń live
function loadOrders(){
  const t = document.getElementById("orders");
  t.innerHTML = "<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th><th>Akcje</th></tr>";

  db.ref("orders").on("value", snapshot => {
    t.innerHTML = "<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th><th>Akcje</th></tr>";
    snapshot.forEach(c => {
      const d = c.val();
      const id = c.key;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${id}</td>
        <td>${d.title}</td>
        <td>${d.status}</td>
        <td>${d.driverId || "-"}</td>
        <td>
          <button onclick="assignDriver('${id}','001')">001</button>
          <button onclick="assignDriver('${id}','002')">002</button>
          <button onclick="assignDriver('${id}','003')">003</button>
          <button onclick="nextStatus('${id}','${d.status}')">Next</button>
        </td>
      `;
      t.appendChild(row);
    });
  });
}

// Przypisanie kierowcy do zlecenia
function assignDriver(orderId, driverId){
  db.ref("orders/"+orderId).update({ driverId });
}

// Zmiana statusu zlecenia
function nextStatus(orderId, current){
  const next = current==="nowe"?"w trasie":current==="w trasie"?"zakończone":"nowe";
  db.ref("orders/"+orderId).update({ status: next });
}

// Mapa kierowców
function initMap(){
  map = L.map("map").setView([51.3,4.5],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  updateDriverMarkers();
}

// Aktualizacja markerów kierowców
function updateDriverMarkers(){
  db.ref("drivers").once("value").then(snap => {
    snap.forEach(c => {
      const d = c.val();
      const id = c.key;
      if(driverMarkers[id]){
        driverMarkers[id].setLatLng([d.lat,d.lng]);
      } else {
        driverMarkers[id] = L.marker([d.lat,d.lng]).addTo(map).bindPopup(d.name);
      }
    });
  });
}

// Start auto-update co minutę
function startDriverUpdates(){
  updateDriverMarkers();
  setInterval(updateDriverMarkers, 60000);
}

</script>

</head>
<body>

<h1>S‑TRANS | Panel Admina</h1>

<div id="login">
  <h2>Logowanie Admin</h2>
  <input id="email" placeholder="email"><br>
  <input id="pass" type="password" placeholder="hasło"><br>
  <button onclick="login()">ZALOGUJ</button>
  <p id="loginError" style="color:red"></p>
</div>

<div id="panel" style="display:none;">
  <h2>Zlecenia</h2>
  <table id="orders"></table>

  <h2>Mapa kierowców</h2>
  <div id="map"></div>
</div>

</body>
</html>
