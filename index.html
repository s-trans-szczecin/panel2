<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>S-TRANS Kierowca</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ================= FIREBASE =================
    const firebaseConfig = {
      apiKey: "AIzaSyAjkKqpO-3_Ltp3Jofc4oDu81Y5pb2IsQk",
      authDomain: "fir-trans-10591.firebaseapp.com",
      databaseURL: "https://fir-trans-10591-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fir-trans-10591",
      storageBucket: "fir-trans-10591.appspot.com",
      messagingSenderId: "454345201943",
      appId: "1:454345201943:web:panel"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let driverCode = null; // np. 001, 002...
    let intervalId = null;

    // ================= LOGOWANIE KIEROWCY =================
    function driverLogin() {
      driverCode = document.getElementById("driverCode").value.trim();
      if(!driverCode) { alert("Podaj kod kierowcy"); return; }

      // Ustawienie statusu online i inicjalizacja pozycji
      updatePosition();

      // Co 1 minutę aktualizuj pozycję
      intervalId = setInterval(updatePosition, 60*1000);

      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("driverPanel").style.display = "block";
    }

    // ================= AKTUALIZACJA POZYCJI =================
    function updatePosition() {
      if(!driverCode) return;

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          db.ref("drivers/" + driverCode).update({
            lat: lat,
            lng: lng,
            status: "online",
            lastUpdate: Date.now()
          });

          document.getElementById("status").innerText = 
            `Pozycja wysłana: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }, err=>{
          console.log("Błąd geolokalizacji", err);
        });
      } else {
        console.log("Geolokalizacja niedostępna");
      }
    }

    // ================= WYLOGOWANIE =================
    function driverLogout() {
      if(driverCode){
        db.ref("drivers/" + driverCode).update({status:"offline"});
      }
      clearInterval(intervalId);
      driverCode = null;
      document.getElementById("driverPanel").style.display = "none";
      document.getElementById("loginContainer").style.display = "block";
    }
  </script>
</head>

<body style="font-family:Arial; background:#111; color:#0ff; padding:20px;">

  <!-- LOGOWANIE KIEROWCY -->
  <div id="loginContainer">
    <h2>S-TRANS Kierowca - Logowanie</h2>
    <input id="driverCode" placeholder="Kod kierowcy (np. 001)"><br><br>
    <button onclick="driverLogin()">Zaloguj</button>
  </div>

  <!-- PANEL KIEROWCY -->
  <div id="driverPanel" style="display:none;">
    <h2>Witaj, kierowco <span id="driverCodeDisplay"></span></h2>
    <p id="status">Status: offline</p>
    <button onclick="driverLogout()">Wyloguj</button>
  </div>

</body>
</html>
