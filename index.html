<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS Panel</title>
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS Panel Admina</title>

<!-- Leaflet do mapy -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial; margin:0; padding:0; }
  #adminPanel { display:none; padding:20px; }
  #admin-left { float:left; width:50%; }
  #admin-right { float:left; width:50%; height:500px; }
  table, th, td { border:1px solid black; border-collapse:collapse; padding:5px; }
  th { background:#eee; }
  #map { height:100%; width:100%; }
  #login-container { padding:20px; }
</style>

<script>
  // üîπ KONFIGURACJA FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyAjkKqpO-3_Ltp3Jofc4oDu81Y5pb2IsQk",
    authDomain: "fir-trans-10591.firebaseapp.com",
    databaseURL: "https://fir-trans-10591-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "fir-trans-10591",
    storageBucket: "fir-trans-10591.appspot.com",
    messagingSenderId: "454345201943",
    appId: "1:454345201943:web:panel"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let mapAdmin = null;
  let markersAdmin = {};

  // üîπ LOGOWANIE
  function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    auth.signInWithEmailAndPassword(email, password)
      .then(user => {
        currentUser = user.user;
        const key = currentUser.email.replace(/\./g, ','); // zamiana wszystkich kropek
        db.ref("users/"+key).once("value").then(snapshot => {
          const data = snapshot.val();
          if(!data || data.role !== "admin") {
            alert("Brak przypisanej roli admina");
            auth.signOut();
            return;
          }

          // poka≈º panel admina
          document.getElementById("login-container").style.display="none";
          document.getElementById("adminPanel").style.display="block";

          loadOrders();
          loadDriversTable();
          initDriversMap();
        });
      })
      .catch(err => { document.getElementById("loginError").innerText=err.message; });
  }

  // üîπ ZLECENIA
  function loadOrders() {
    const table = document.getElementById("ordersTable");
    table.innerHTML="";
    db.ref("orders").on("value", snapshot=>{
      table.innerHTML="";
      snapshot.forEach(child=>{
        const data = child.val();
        const id = child.key;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${id}</td>
          <td>${data.title}</td>
          <td>${data.status}</td>
          <td>${data.driverId||"-"}</td>
          <td>
            <button onclick="setDriver('${id}','001')">001</button>
            <button onclick="setDriver('${id}','002')">002</button>
            <button onclick="nextStatus('${id}','${data.status}')">Status</button>
          </td>
        `;
        table.appendChild(row);
      });
    });
  }

  function setDriver(id, driver){
    db.ref("orders/"+id).update({ driverId: driver });
  }

  function nextStatus(id,current){
    const next = current==="nowe"?"w trasie":current==="w trasie"?"zako≈Ñczone":"nowe";
    db.ref("orders/"+id).update({status:next});
  }

  function createOrder() {
    const title = prompt("Tytu≈Ç zlecenia:");
    if(!title) return;
    const newRef = db.ref("orders").push();
    newRef.set({ title:title, status:"nowe", driverId:"" });
  }

  // üîπ KIEROWCY - tabela i mapa
  function loadDriversTable() {
    const table = document.getElementById("driversTable");
    table.innerHTML="";
    db.ref("drivers").on("value", snapshot=>{
      table.innerHTML="";
      snapshot.forEach(child=>{
        const data = child.val();
        const id = child.key;
        const row = document.createElement("tr");
        row.innerHTML = `<td>${id}</td><td>${data.name}</td><td>${data.status}</td>`;
        table.appendChild(row);
      });
    });
  }

  function initDriversMap() {
    mapAdmin = L.map('driversMap').setView([50,10], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(mapAdmin);

    db.ref("drivers").on("value", snapshot=>{
      snapshot.forEach(child=>{
        const id = child.key;
        const data = child.val();
        if(markersAdmin[id]){
          markersAdmin[id].setLatLng([data.lat,data.lng]);
          markersAdmin[id].bindPopup(`${data.name} (${id}) - ${data.status}`);
        } else {
          markersAdmin[id] = L.marker([data.lat,data.lng]).addTo(mapAdmin)
            .bindPopup(`${data.name} (${id}) - ${data.status}`);
        }
      });
    });
  }
</script>
</head>
<body>

<!-- LOGOWANIE -->
<div id="login-container">
  <h2>S-TRANS Panel Admina</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Has≈Ço">
  <button onclick="login()">Zaloguj</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- PANEL ADMINA -->
<div id="adminPanel">
  <div id="admin-left">
    <h3>Zlecenia</h3>
    <button onclick="createOrder()">Nowe Zlecenie</button>
    <table>
      <thead><tr><th>ID</th><th>Tytu≈Ç</th><th>Status</th><th>Kierowca</th><th>Akcje</th></tr></thead>
      <tbody id="ordersTable"></tbody>
    </table>

    <h3>Kierowcy</h3>
    <table>
      <thead><tr><th>ID</th><th>Nazwa</th><th>Status</th></tr></thead>
      <tbody id="driversTable"></tbody>
    </table>
  </div>

  <div id="admin-right">
    <h3>Mapa kierowc√≥w</h3>
    <div id="driversMap" style="height:500px;"></div>
  </div>

  <div style="clear:both;"></div>
</div>

</body>
</html>

<!-- Leaflet do map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial; margin:0; padding:0; }
  #adminPanel, #driverPanel { display:none; padding:20px; }
  #admin-left { float:left; width:50%; }
  #admin-right { float:left; width:50%; height:500px; }
  table, th, td { border:1px solid black; border-collapse:collapse; padding:5px; }
  th { background:#eee; }
  #logoScreen, #mapScreen { position:absolute; top:0; left:0; right:0; bottom:0; display:none; background:#111; color:#fff; text-align:center; font-size:50px; }
  #map { height:100%; width:100%; }
</style>

<script>
  // üîπ KONFIGURACJA FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyAjkKqpO-3_Ltp3Jofc4oDu81Y5pb2IsQk",
    authDomain: "fir-trans-10591.firebaseapp.com",
    databaseURL: "https://fir-trans-10591-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "fir-trans-10591",
    storageBucket: "fir-trans-10591.appspot.com",
    messagingSenderId: "454345201943",
    appId: "1:454345201943:web:panel"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let driverCode = null;
  let intervalId = null;
  let mapAdmin, markersAdmin = {};

  // üîπ LOGO ANIMOWANE
  function showLogo() {
    const logoScreen = document.getElementById("logoScreen");
    logoScreen.style.display = "block";
    setTimeout(() => {
      logoScreen.style.display = "none";
      showMap();
    }, 3000);
  }

  // üîπ MAPA STARTOWA (pe≈Çny ≈õwiat)
  function showMap() {
    const mapScreen = document.getElementById("mapScreen");
    mapScreen.style.display = "block";

    const map = L.map('mapScreen').setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    setTimeout(() => {
      mapScreen.style.display = "none";
      document.getElementById("login-container").style.display = "block";
    },3000);
  }

  // üîπ LOGOWANIE
  function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    auth.signInWithEmailAndPassword(email, password)
      .then(user => {
        currentUser = user.user;
        const key = currentUser.email.replace(/\./g, ','); // zamiana wszystkich kropek
        db.ref("users/"+key).once("value").then(snapshot => {
          const data = snapshot.val();
          if(!data) { alert("Brak przypisanej roli"); auth.signOut(); return; }

          // ukryj wszystko
          document.getElementById("login-container").style.display="none";
          document.getElementById("adminPanel").style.display="none";
          document.getElementById("driverPanel").style.display="none";

          if(data.role==="admin") {
            document.getElementById("adminPanel").style.display="block";
            loadOrders();
            loadDrivers();
            loadDriversOnMap();
          } else if(data.role==="driver") {
            driverCode = data.driverCode;
            document.getElementById("driverPanel").style.display="block";
            document.getElementById("driverCodeDisplay").innerText = driverCode;
            updateDriverPosition();
            intervalId = setInterval(updateDriverPosition, 60000);
          }
        });
      })
      .catch(err => { document.getElementById("loginError").innerText=err.message; });
  }

  // üîπ WYLOGOWANIE KIEROWCY
  function driverLogout() {
    clearInterval(intervalId);
    auth.signOut();
    driverCode = null;
    document.getElementById("driverPanel").style.display="none";
    document.getElementById("login-container").style.display="block";
  }

  // üîπ PANEL ADMINA - ZLECENIA
  function createOrder() {
    const title = prompt("Tytu≈Ç zlecenia:");
    if(!title) return;
    const newRef = db.ref("orders").push();
    newRef.set({ title:title, status:"nowe", driverId:"" });
  }

  function loadOrders() {
    const table = document.getElementById("admin-ordersTable");
    table.innerHTML="";
    db.ref("orders").on("value", snapshot=>{
      table.innerHTML="";
      snapshot.forEach(child=>{
        const data = child.val();
        const id = child.key;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${id}</td>
          <td>${data.title}</td>
          <td>${data.status}</td>
          <td>${data.driverId||"-"}</td>
          <td>
            <button onclick="setDriver('${id}','001')">001</button>
            <button onclick="setDriver('${id}','002')">002</button>
            <button onclick="nextStatus('${id}','${data.status}')">Status</button>
          </td>
        `;
        table.appendChild(row);
      });
    });
  }

  function setDriver(id, driver){
    db.ref("orders/"+id).update({ driverId: driver });
  }

  function nextStatus(id,current){
    const next = current==="nowe"?"w trasie":current==="w trasie"?"zako≈Ñczone":"nowe";
    db.ref("orders/"+id).update({status:next});
  }

  // üîπ PANEL ADMINA - KIEROWCY + MAPA
  function loadDrivers() {
    const table = document.getElementById("admin-driversTable");
    table.innerHTML="";
    db.ref("drivers").on("value", snapshot=>{
      table.innerHTML="";
      snapshot.forEach(child=>{
        const data = child.val();
        const id = child.key;
        const row = document.createElement("tr");
        row.innerHTML = `<td>${id}</td><td>${data.name}</td>`;
        table.appendChild(row);
      });
    });
  }

  function loadDriversOnMap() {
    mapAdmin = L.map('admin-map').setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(mapAdmin);

    db.ref("drivers").on("value", snapshot=>{
      snapshot.forEach(child=>{
        const id = child.key;
        const data = child.val();
        if(markersAdmin[id]){
          markersAdmin[id].setLatLng([data.lat,data.lng]);
        } else {
          markersAdmin[id] = L.marker([data.lat,data.lng]).addTo(mapAdmin)
            .bindPopup(`${data.name} (${id}) - ${data.status}`);
        }
      });
    });
  }

  // üîπ KIEROWCA - wysy≈Çanie pozycji co 1 minutƒô
  function updateDriverPosition() {
    if(!driverCode) return;
    // przyk≈Çadowa pozycja losowa wok√≥≈Ç Europy (lat/lng)
    const lat = 50 + Math.random();
    const lng = 10 + Math.random();
    db.ref("drivers/"+driverCode).update({lat:lat,lng:lng,status:"online"});
    document.getElementById("driver-status").innerText = "Status: online";
  }

  window.onload = showLogo;

</script>
</head>
<body>

<!-- LOGO ANIMOWANE -->
<div id="logoScreen">S-TRANS</div>

<!-- MAPA STARTOWA -->
<div id="mapScreen"></div>

<!-- LOGOWANIE -->
<div id="login-container">
  <h2>Logowanie</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Has≈Ço">
  <button onclick="login()">Zaloguj</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- PANEL ADMINA -->
<div id="adminPanel">
  <div id="admin-left">
    <h2>Panel Zlece≈Ñ</h2>
    <button onclick="createOrder()">Nowe Zlecenie</button>
    <table>
      <thead>
        <tr><th>ID</th><th>Tytu≈Ç</th><th>Status</th><th>Kierowca</th><th>Akcje</th></tr>
      </thead>
      <tbody id="admin-ordersTable"></tbody>
    </table>

    <h3>Kierowcy</h3>
    <table>
      <thead><tr><th>ID</th><th>Nazwa</th></tr></thead>
      <tbody id="admin-driversTable"></tbody>
    </table>
  </div>
  <div id="admin-right">
    <h2>Mapa kierowc√≥w</h2>
    <div id="admin-map"></div>
  </div>
  <div style="clear:both;"></div>
</div>

<!-- PANEL KIEROWCY -->
<div id="driverPanel">
  <h2>Witaj, kierowco <span id="driverCodeDisplay"></span></h2>
  <p id="driver-status">Status: offline</p>
  <button onclick="driverLogout()">Wyloguj</button>
</div>

</body>
</html>
