<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS | Panel Admina</title>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial; background:#0b0f1a; color:white; }
#splash, #login, #panel { display:none; }
#splash {
  height:100vh; display:flex; align-items:center; justify-content:center;
  font-size:48px; letter-spacing:5px;
  background:linear-gradient(135deg,#0ff,#003);
  animation:pulse 2s infinite;
}
@keyframes pulse { 0%{opacity:.4} 50%{opacity:1} 100%{opacity:.4} }

#panel { display:flex; height:100vh; }
#orders { width:40%; padding:10px; overflow:auto; }
#map { width:60%; height:100%; }

table { width:100%; border-collapse:collapse; }
td,th { border:1px solid #444; padding:5px; text-align:center; }
button { background:#0ff; border:none; padding:5px; cursor:pointer; }
</style>

<script>
/* === FIREBASE KONFIGURACJA (panel-admina) === */
const firebaseConfig = {
  apiKey: "AIzaSyAqm4Z8xeZ1mYelt4giRQknCWG6RMzAs8c",
  authDomain: "fir-trans-projekt.firebaseapp.com",
  databaseURL: "https://fir-trans-projekt-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fir-trans-projekt",
  storageBucket: "fir-trans-projekt.firebasestorage.app",
  messagingSenderId: "285753383667",
  appId: "1:285753383667:web:95eaac335c2a1f1f3a3586",
  measurementId: "G-DSEY52E77K"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let map;
let markers = {};

/* === START === */
window.onload = () => {
  document.getElementById("splash").style.display="flex";
  setTimeout(()=>{
    document.getElementById("splash").style.display="none";
    document.getElementById("login").style.display="block";
  },2000);
};

/* === LOGOWANIE === */
function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  if(!email || !password){
    document.getElementById('loginError').innerText = "Wpisz email i hasło!";
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      const user = userCredential.user;
      db.ref("users/"+user.uid).once("value").then(snap=>{
        if(!snap.exists() || snap.val().role!=="admin"){
          alert("Brak przypisanej roli ADMIN");
          auth.signOut();
          return;
        }
        document.getElementById("login").style.display="none";
        document.getElementById("panel").style.display="flex";
        initMap();
        loadOrders();
        loadDrivers();
      });
    })
    .catch(err=>{
      document.getElementById('loginError').innerText = err.message;
    });
}

// Enter w polu hasła
window.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('password').addEventListener('keyup', e=>{
    if(e.key==='Enter') login();
  });
});

/* === MAPA === */
function initMap(){
  map = L.map('map').setView([53.4285,14.5528],13); // Szczecin
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

/* === KIEROWCY === */
function loadDrivers(){
  db.ref("drivers").on("value", snap=>{
    snap.forEach(d=>{
      const id = d.key;
      const v = d.val();
      if(!v.lat || !v.lng) return;

      if(markers[id]) {
        markers[id].setLatLng([v.lat,v.lng]);
      } else {
        markers[id] = L.marker([v.lat,v.lng])
          .addTo(map)
          .bindPopup(v.name);
      }
    });
  });
}

/* === ZLECENIA === */
function loadOrders(){
  const t = ordersTable;
  t.innerHTML="<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th></tr>";

  db.ref("orders").on("value", snap=>{
    t.innerHTML="<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th></tr>";
    snap.forEach(o=>{
      const d=o.val();
      const r=t.insertRow();
      r.innerHTML=`
        <td>${o.key}</td>
        <td>${d.title}</td>
        <td>${d.status}</td>
        <td>${d.driverId||"-"}</td>
      `;
    });
  });
}

function newOrder(){
  const t=prompt("Tytuł zlecenia");
  if(!t) return;
  db.ref("orders").push({title:t,status:"nowe",driverId:""});
}
</script>

</head>
<body>

<div id="splash">S-TRANS</div>

<div id="login">
  <h2>Logowanie admina</h2>
  <input id="email" placeholder="email"><br><br>
  <input id="password" type="password" placeholder="hasło"><br><br>
  <button id="loginBtn">Zaloguj</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="panel">
  <div id="orders">
    <h2>Zlecenia</h2>
    <button onclick="newOrder()">+ Nowe</button>
    <table id="ordersTable"></table>
  </div>
  <div id="map"></div>
</div>

</body>
</html>
