<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS | Panel Admina</title>

<!-- Firebase COMPAT SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial; background:#0b0f1a; color:white; }
#splash, #login, #panel { display:none; }
#splash {
  height:100vh; display:flex; align-items:center; justify-content:center;
  font-size:48px; letter-spacing:5px;
  background:linear-gradient(135deg,#0ff,#003);
  animation:pulse 2s infinite;
}
@keyframes pulse { 0%{opacity:.4} 50%{opacity:1} 100%{opacity:.4} }

#panel { display:flex; height:100vh; }
#orders { width:40%; padding:10px; overflow:auto; }
#map { width:60%; height:100%; }

table { width:100%; border-collapse:collapse; }
td,th { border:1px solid #444; padding:5px; text-align:center; }
button { background:#0ff; border:none; padding:5px; cursor:pointer; margin:2px; }
input { padding:5px; margin:5px 0; width:90%; }
</style>

<script>
// === KONFIGURACJA FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyAqm4Z8xeZ1mYelt4giRQknCWG6RMzAs8c",
  authDomain: "fir-trans-projekt.firebaseapp.com",
  databaseURL: "https://fir-trans-10591-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fir-trans-projekt",
  storageBucket: "fir-trans-projekt.firebasestorage.app",
  messagingSenderId: "285753383667",
  appId: "1:285753383667:web:95eaac335c2a1f1f3a3586",
  measurementId: "G-DSEY52E77K"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let map;
let markers = {};

// === START ===
window.onload = () => {
  document.getElementById("splash").style.display = "flex";
  setTimeout(()=>{
    document.getElementById("splash").style.display = "none";
    document.getElementById("login").style.display = "block";
  },2000);
};

// === LOGOWANIE ADMINA ===
function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  auth.signInWithEmailAndPassword(email,password)
    .catch(e=>alert(e.message));
}

// === AUTORYZACJA ADMINA ===
auth.onAuthStateChanged(user=>{
  if(!user) return;

  db.ref("users/"+user.uid).once("value").then(snap=>{
    if(!snap.exists() || snap.val().role!=="admin"){
      alert("Brak przypisanej roli ADMIN");
      auth.signOut();
      return;
    }
    document.getElementById("login").style.display="none";
    document.getElementById("panel").style.display="flex";
    initMap();
    loadDrivers();
    loadOrders();
  });
});

// === MAPA ===
function initMap(){
  map = L.map('map').setView([52,19],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

// === KIEROWCY ===
function loadDrivers(){
  db.ref("drivers").on("value", snap=>{
    snap.forEach(d=>{
      const id = d.key;
      const v = d.val();
      if(!v.lat || !v.lng) return;

      if(markers[id]){
        markers[id].setLatLng([v.lat,v.lng]);
      } else {
        markers[id] = L.marker([v.lat,v.lng])
          .addTo(map)
          .bindPopup("Kierowca "+id);
      }
    });
  });
}

// === ZLECENIA ===
function loadOrders(){
  const t = document.getElementById("ordersTable");
  t.innerHTML="<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th><th>Akcje</th></tr>";

  db.ref("orders").on("value", snap=>{
    t.innerHTML="<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th><th>Akcje</th></tr>";
    snap.forEach(o=>{
      const d=o.val();
      const row = t.insertRow();
      row.innerHTML=`
        <td>${o.key}</td>
        <td>${d.title}</td>
        <td>${d.status}</td>
        <td>${d.driverId||"-"}</td>
        <td>
          <button onclick="assignDriver('${o.key}','driver_001')">001</button>
          <button onclick="assignDriver('${o.key}','driver_002')">002</button>
          <button onclick="nextStatus('${o.key}','${d.status}')">Status</button>
        </td>
      `;
    });
  });
}

// === FUNKCJE PANELU ===
function assignDriver(orderId, driverId){
  db.ref("orders/"+orderId).update({ driverId: driverId });
}

function nextStatus(orderId, current){
  const next = current==="nowe" ? "w trasie" : current==="w trasie" ? "zakończone" : "nowe";
  db.ref("orders/"+orderId).update({ status: next });
}

function newOrder(){
  const title = prompt("Tytuł zlecenia:");
  if(!title) return;
  db.ref("orders").push({ title:title, status:"nowe", driverId:"" });
}
</script>
</head>

<body>
<div id="splash">S-TRANS</div>

<div id="login">
  <h2>Logowanie admina</h2>
  <input id="email" placeholder="email"><br>
  <input id="password" type="password" placeholder="hasło"><br>
  <button onclick="login()">Zaloguj</button>
</div>

<div id="panel">
  <div id="orders">
    <h2>Zlecenia</h2>
    <button onclick="newOrder()">+ Nowe</button>
    <table id="ordersTable"></table>
  </div>
  <div id="map"></div>
</div>
</body>
</html>
