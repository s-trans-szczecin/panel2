<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS Panel Transport</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Futuristic Font -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">

<style>
body { margin:0; font-family:'Arial', sans-serif; background:#111; color:#0ff; }
#logoScreen,#mapScreen,#login-container,#adminPanel,#driverPanel { display:none; padding:20px; }
#logoScreen h1 { font-family:'Orbitron', sans-serif; font-size:70px; text-align:center; animation: neonPulse 1.5s infinite alternate; }
#logoScreen p { text-align:center; animation: flicker 2s infinite; }
@keyframes neonPulse { 0% { text-shadow:0 0 5px #0ff,0 0 10px #0ff; } 50% { text-shadow:0 0 20px #0ff,0 0 40px #0ff; } 100% { text-shadow:0 0 5px #0ff,0 0 10px #0ff; } }
@keyframes flicker { 0%,100%{opacity:1;}50%{opacity:0.4;} }
#map,#admin-map { height:400px; margin-top:10px; }
table { border-collapse: collapse; width:100%; margin-top:10px; background:#222; color:#0ff; }
th,td { padding:6px 10px; border:1px solid #0ff; text-align:center; }
.panel-wrapper { display:flex; gap:20px; }
#admin-left { flex:1; }
#admin-right { flex:1; }
button { background:#0ff; color:#111; border:none; padding:5px 8px; cursor:pointer; margin:2px; }
input { padding:5px; margin:2px 0; width:90%; }
</style>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyAjkKqpO-3_Ltp3Jofc4oDu81Y5pb2IsQk",
  authDomain: "fir-trans-10591.firebaseapp.com",
  databaseURL: "https://fir-trans-10591-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fir-trans-10591",
  storageBucket: "fir-trans-10591.appspot.com",
  messagingSenderId: "454345201943",
  appId: "1:454345201943:web:panel"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser=null;
let driverCode=null;
let intervalId=null;
let map=null;
let markers={};

// ================= LOGO =================
function showLogo(){
  document.getElementById("logoScreen").style.display="block";
  setTimeout(()=>{
    document.getElementById("logoScreen").style.display="none";
    showMapScreen();
  },3000);
}

// ================= MAPA STARTOWA =================
function showMapScreen(){
  document.getElementById("mapScreen").style.display="block";
  map = L.map('map').setView([20,0],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  db.ref("drivers").on("value", snapshot=>{
    const data = snapshot.val();
    for(const key in data){
      const driver=data[key];
      if(!driver.lat) driver.lat=0;
      if(!driver.lng) driver.lng=0;
      if(!markers[key]){
        markers[key]=L.marker([driver.lat,driver.lng]).addTo(map)
          .bindPopup(`${key}: ${driver.status||'offline'}`);
      } else {
        markers[key].setLatLng([driver.lat,driver.lng])
          .setPopupContent(`${key}: ${driver.status||'offline'}`);
      }
    }
  });

  setTimeout(()=>{
    document.getElementById("mapScreen").style.display="none";
    document.getElementById("login-container").style.display="block";
  },3000);
}

// ================= LOGOWANIE =================
function login(){
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!email || !password) return alert("Podaj email i hasło");

  auth.signInWithEmailAndPassword(email,password)
    .then(user=>{
      currentUser=user.user;
      const key = email.replace(/\./g,",");
      db.ref("users/"+key).once("value").then(snapshot=>{
        const data = snapshot.val();
        if(!data){ alert("Brak przypisanej roli"); auth.signOut(); return; }

        // Ukryj wszystkie panele
        document.getElementById("adminPanel").style.display="none";
        document.getElementById("driverPanel").style.display="none";

        if(data.role==="admin"){
          document.getElementById("login-container").style.display="none";
          document.getElementById("adminPanel").style.display="block";
          loadOrders();
          loadDrivers();
          loadDriversOnMap();
        } else if(data.role==="driver"){
          driverCode = data.driverCode;
          document.getElementById("login-container").style.display="none";
          document.getElementById("driverPanel").style.display="block";
          document.getElementById("driverCodeDisplay").innerText=driverCode;
          updatePosition();
          intervalId = setInterval(updatePosition, 60*1000);
        }
      });
    })
    .catch(err=>{ document.getElementById("loginError").innerText = err.message; });
}

// ================= PANEL KIEROWCY =================
function updatePosition(){
  if(!driverCode) return;
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      db.ref("drivers/"+driverCode).update({lat,lng,status:"online",lastUpdate:Date.now()});
      document.getElementById("driver-status").innerText=`Pozycja wysłana: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    });
  }
}
function driverLogout(){
  if(driverCode) db.ref("drivers/"+driverCode).update({status:"offline"});
  clearInterval(intervalId);
  driverCode=null;
  document.getElementById("driverPanel").style.display="none";
  document.getElementById("login-container").style.display="block";
}

// ================= PANEL ADMINA =================
function createOrder(){
  const title=prompt("Tytuł zlecenia:");
  if(!title) return;
  db.ref("orders").push({title,status:"nowe",driverId:""});
}

function loadOrders(){
  const table = document.getElementById("admin-ordersTable");
  table.innerHTML="";
  db.ref("orders").on("value",snapshot=>{
    table.innerHTML="";
    snapshot.forEach(child=>{
      const data=child.val();
      const id=child.key;
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${id}</td>
        <td>${data.title}</td>
        <td>${data.status}</td>
        <td>${data.driverId||"-"}</td>
        <td>
          <button onclick="setDriver('${id}','001')">001</button>
          <button onclick="setDriver('${id}','002')">002</button>
          <button onclick="nextStatus('${id}','${data.status}')">Status</button>
        </td>
      `;
      table.appendChild(row);
    });
  });
}
function setDriver(id,driver){ db.ref("orders/"+id).update({driverId:driver}); }
function nextStatus(id,current){ const next=current==="nowe"?"w trasie":current==="w trasie"?"zakończone":"nowe"; db.ref("orders/"+id).update({status:next}); }

function loadDrivers(){
  const table = document.getElementById("admin-driversTable");
  table.innerHTML="";
  db.ref("drivers").once("value").then(snapshot=>{
    const data = snapshot.val();
    for(const key in data){
      const driver = data[key];
      const row = document.createElement("tr");
      row.innerHTML = `<td>${key}</td><td>${driver.name||driver}</td>`;
      table.appendChild(row);
    }
  });
}

function loadDriversOnMap(){
  db.ref("drivers").on("value",snapshot=>{
    const data=snapshot.val();
    for(const key in data){
      const driver = data[key];
      if(!driver.lat) driver.lat=0;
      if(!driver.lng) driver.lng=0;
      if(!markers[key]){
        markers[key]=L.marker([driver.lat,driver.lng]).addTo(map)
          .bindPopup(`${key}: ${driver.status||'offline'}`);
      } else {
        markers[key].setLatLng([driver.lat,driver.lng])
          .setPopupContent(`${key}: ${driver.status||'offline'}`);
      }
    }
  });
}

window.onload=showLogo;
</script>
</head>

<body>
<!-- LOGO -->
<div id="logoScreen">
<h1>S-TRANS</h1>
<p>Ładunki. Kierowcy. Kontrola.</p>
</div>

<!-- MAPA STARTOWA -->
<div id="mapScreen">
<h2>Mapa świata</h2>
<div id="map"></div>
</div>

<!-- LOGOWANIE -->
<div id="login-container">
<h2>Logowanie</h2>
<input id="email" placeholder="email"><br>
<input id="password" type="password" placeholder="hasło"><br>
<button onclick="login()">Zaloguj</button>
<p id="loginError" style="color:red;"></p>
</div>

<!-- PANEL ADMINA -->
<div id="adminPanel">
<div class="panel-wrapper">
<div id="admin-left">
<h2>Panel zleceń</h2>
<button onclick="createOrder()">➕ Nowe zlecenie</button>
<table>
<thead><tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th><th>Akcje</th></tr></thead>
<tbody id="admin-ordersTable"></tbody>
</table>

<h3>Kierowcy</h3>
<table>
<thead><tr><th>ID</th><th>Nazwa</th></tr></thead>
<tbody id="admin-driversTable"></tbody>
</table>
</div>
<div id="admin-right">
<h2>Mapa kierowców</h2>
<div id="admin-map" style="height:500px;"></div>
</div>
</div>
</div>

<!-- PANEL KIEROWCY -->
<div id="driverPanel">
<h2>Witaj, kierowco <span id="driverCodeDisplay"></span></h2>
<p id="driver-status">Status: offline</p>
<button onclick="driverLogout()">Wyloguj</button>
</div>

</body>
</html>
