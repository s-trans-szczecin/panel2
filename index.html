<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>S-TRANS | Panel Admina</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; font-family:Arial; background:#0b0f1a; color:#fff; }
h1 { text-align:center; padding:20px; letter-spacing:3px; }
#login, #panel { padding:20px; }
input, button { padding:10px; margin:5px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
td, th { border:1px solid #333; padding:6px; text-align:center; }
#map { height:400px; margin-top:20px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAjkKqpO-3_Ltp3Jofc4oDu81Y5pb2IsQk",
  authDomain: "fir-trans-10591.firebaseapp.com",
  databaseURL: "https://fir-trans-10591-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fir-trans-10591",
  storageBucket: "fir-trans-10591.appspot.com",
  messagingSenderId: "454345201943",
  appId: "1:454345201943:web:panel"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let map;
let markers = {};

function login() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("pass").value;

  auth.signInWithEmailAndPassword(email, pass).then(res => {
    const uid = res.user.uid;

    db.ref("users/" + uid + "/role").once("value").then(snap => {
      if (snap.val() === "admin") {
        document.getElementById("login").style.display="none";
        document.getElementById("panel").style.display="block";
        loadOrders();
        initMap();
      } else {
        alert("BRAK PRZYPISANEJ ROLI");
        auth.signOut();
      }
    });
  }).catch(e => alert(e.message));
}

function loadOrders() {
  const t = document.getElementById("orders");
  t.innerHTML = "<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th></tr>";

  db.ref("orders").on("value", s => {
    t.innerHTML = "<tr><th>ID</th><th>Tytuł</th><th>Status</th><th>Kierowca</th></tr>";
    s.forEach(c => {
      const d = c.val();
      t.innerHTML += `<tr>
        <td>${c.key}</td>
        <td>${d.title}</td>
        <td>${d.status}</td>
        <td>${d.driverId || "-"}</td>
      </tr>`;
    });
  });
}

function initMap() {
  map = L.map("map").setView([51.3,4.5],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  db.ref("drivers").on("value", s => {
    s.forEach(c => {
      const d = c.val();
      if (!markers[c.key]) {
        markers[c.key] = L.marker([d.lat,d.lng]).addTo(map).bindPopup(d.name);
      } else {
        markers[c.key].setLatLng([d.lat,d.lng]);
      }
    });
  });
}
</script>
</head>

<body>

<h1>S‑TRANS</h1>

<div id="login">
  <input id="email" placeholder="email"><br>
  <input id="pass" type="password" placeholder="hasło"><br>
  <button onclick="login()">ZALOGUJ</button>
</div>

<div id="panel" style="display:none">
  <h2>Zlecenia</h2>
  <table id="orders"></table>

  <h2>Mapa kierowców</h2>
  <div id="map"></div>
</div>

</body>
</html>
